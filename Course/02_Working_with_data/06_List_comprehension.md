[Зміст](../Contents.md) \| [Попередній розділ (2.5. Модуль колекцій)](05_Collections.md) \| [Наступний розділ (2.7. Об'єкти)](07_Objects.md)

# 2.6 Компрехенція списку

Поширеним завданням є обробка елементів у списку. У цьому розділі представлено компрехенцію списків, потужний інструмент для виконання саме цього.

### Створення нових списків

Компрехенція списку створює новий список шляхом застосування операції до кожного елемента послідовності.

```python
>>> a = [1, 2, 3, 4, 5]
>>> b = [2*x for x in a ]
>>> b
[2, 4, 6, 8, 10]
>>>
```

Інший приклад:
```python
>>> names = ['Elwood', 'Jake']
>>> a = [name.lower() for name in names]
>>> a
['elwood', 'jake']
>>>
```

Загальний синтаксис: `[ <expression> for <variable_name> in <sequence> ]`.

### Фільтрування

Ви також можете фільтрувати під час компрехенції списку.
```python
>>> a = [1, -5, 4, 2, -2, 10]
>>> b = [2*x for x in a if x > 0 ]
>>> b
[2, 8, 4, 20]
>>>
```

### Способи використання

Компрехенції списків є надзвичайно корисними. Наприклад, ви можете збирати значення певних полів словника:

```python
stocknames = [s['name'] for s in stocks]
```

До послідовностей можна виконувати запити, як до бази даних.
```python
a = [s for s in stocks if s['price'] > 100 and s['shares'] > 50 ]
```

Ви також можете поєднати компрехенцію списку зі скороченням послідовності:

```python
cost = sum([s['shares']*s['price'] for s in stocks])
```

### Загальний синтаксис

```code
[ <expression> for <variable_name> in <sequence> if <condition>]
```

Що це означає:

```python
result = []
for variable_name in sequence:
    if condition:
        result.append(expression)
```

### Історичний екскурс

Компрехенція списків походить від математики (нотація побудови наборів).
```code
a = [ x * x for x in s if x > 0 ] # Python

a = { x^2 | x ∈ s, x > 0 }         # Math
```

Також це реалізовано в інших мовах. Більшість програмістів, ймовірно, і не думають про свої уроки математики. Тому розглядати компрехенцію просто як круту фішку зі списками теж ОК.

## Вправи

Почніть із запуску програми `report.py`, щоб у вас був завантажений портфель акцій в інтерактивному режимі.

```bash
bash % python3 -i report.py
```

Тепер у інтерактивному рядку Python введіть оператори для виконання операцій, описаних нижче. Ці операції виконують різні види скорочення даних, перетворення та запити до даних портфоліо.

### Вправа 2.19: Компрехенція списку

Спробуйте кілька простих списків, щоб ознайомитися з синтаксисом.
```python
>>> nums = [1,2,3,4]
>>> squares = [ x * x for x in nums ]
>>> squares
[1, 4, 9, 16]
>>> twice = [ 2 * x for x in nums if x > 2 ]
>>> twice
[6, 8]
>>>
```
Зверніть увагу, як компрехенції списків створюють нові списки із належним чином перетвореними або відфільтрованими даними.

### Вправа 2.20: Скорочення послідовності

Обчисліть загальну вартість портфоліо за допомогою одного рядка коду Python.
```python
>>> portfolio = read_portfolio('Data/portfolio.csv')
>>> cost = sum([ s['shares'] * s['price'] for s in portfolio ])
>>> cost
44671.15
>>>
```

Після цього покажіть, як можна обчислити поточну вартість портфеля за допомогою одного рядка коду.
```python
>>> value = sum([ s['shares'] * prices[s['name']] for s in portfolio ])
>>> value
28686.1
>>>
```

Обидві наведені вище операції є прикладом скорочення відображення (map-reduce). Компрехенція списку – це відображення операції в списку.
```python
>>> [ s['shares'] * s['price'] for s in portfolio ]
[3220.0000000000005, 4555.0, 12516.0, 10246.0, 3835.1499999999996, 3254.9999999999995, 7044.0]
>>>
```

Тоді функція `sum()` виконує скорочення результату:
```python
>>> sum(_)
44671.15
>>>
```

З цими знаннями ви тепер готові розпочати власний біґ-дейта стартап.

### Вправа 2.21: Запити даних

Спробуйте наступні приклади різноманітних запитів даних.

По-перше, список усіх портфелів із понад 100 акцій.
```python
>>> more100 = [ s for s in portfolio if s['shares'] > 100 ]
>>> more100
[{'price': 83.44, 'name': 'CAT', 'shares': 150}, {'price': 51.23, 'name': 'MSFT', 'shares': 200}]
>>>
```

Усі пакети акцій MSFT та IBM.
```python
>>> msftibm = [ s for s in portfolio if s['name'] in {'MSFT','IBM'} ]
>>> msftibm
[{'price': 91.1, 'name': 'IBM', 'shares': 50}, {'price': 51.23, 'name': 'MSFT', 'shares': 200},
  {'price': 65.1, 'name': 'MSFT', 'shares': 50}, {'price': 70.44, 'name': 'IBM', 'shares': 100}]
>>>
```

Список усіх портфельних активів, вартість яких перевищує 10 000 доларів США.
```python
>>> cost10k = [ s for s in portfolio if s['shares'] * s['price'] > 10000 ]
>>> cost10k
[{'price': 83.44, 'name': 'CAT', 'shares': 150}, {'price': 51.23, 'name': 'MSFT', 'shares': 200}]
>>>
```

### Вправа 2.22: Витягнення даних

Покажіть, як ви можете створити список таплів `(name, shares)`, де `name` і `shares` беруться з `portfolio`.
```python
>>> name_shares =[ (s['name'], s['shares']) for s in portfolio ]
>>> name_shares
[('AA', 100), ('IBM', 50), ('CAT', 150), ('MSFT', 200), ('GE', 95), ('MSFT', 50), ('IBM', 100)]
>>>
```

Якщо ви заміните квадратні дужки (`[`,`]`) на фігурні (`{`, `}`), ви отримаєте щось, відоме як компрехенція сетів. Це дасть вам унікальні значення.

Наприклад, визначити набір унікальних назв акцій, які відображаються в `portfolio`:
```python
>>> names = { s['name'] for s in portfolio }
>>> names
{ 'AA', 'GE', 'IBM', 'MSFT', 'CAT' }
>>>
```

Якщо при цьому ви вкажете пари "ключ:значення", ви зможете створити словник. Наприклад, створіть словник, який зіставлятиме назву акції із загальною кількістю утримуваних акцій.
```python
>>> holdings = { name: 0 for name in names }
>>> holdings
{'AA': 0, 'GE': 0, 'IBM': 0, 'MSFT': 0, 'CAT': 0}
>>>
```

Ця остання функція відома як **компрехенція словника**. Зведемо все в таблицю:
```python
>>> for s in portfolio:
        holdings[s['name']] += s['shares']

>>> holdings
{ 'AA': 100, 'GE': 95, 'IBM': 150, 'MSFT':250, 'CAT': 150 }
>>>
```

Спробуйте цей приклад, який фільтрує словник `prices` лише до тих акцій, які з’являються в портфоліо:

```python
>>> portfolio_prices = { name: prices[name] for name in names }
>>> portfolio_prices
{'AA': 9.22, 'GE': 13.48, 'IBM': 106.28, 'MSFT': 20.89, 'CAT': 35.46}
>>>
```

### Вправа 2.23: Вилучення даних із файлів CSV

Знання того, як використовувати різні комбінації списків, наборів і словників, може бути корисним у різних формах обробки даних. Ось приклад, який показує, як витягти вибрані стовпці з файлу CSV.

Спочатку прочитайте рядок інформації заголовка з файлу CSV:
```python
>>> import csv
>>> f = open('Data/portfoliodate.csv')
>>> rows = csv.reader(f)
>>> headers = next(rows)
>>> headers
['name', 'date', 'time', 'shares', 'price']
>>>
```

Далі визначте змінну, яка містить список стовпців, які вас дійсно цікавлять:
```python
>>> select = ['name', 'shares', 'price']
>>>
```

Тепер знайдіть індекси наведених вище стовпців у вихідному файлі CSV:

```python
>>> indices = [ headers.index(colname) for colname in select ]
>>> indices
[0, 3, 4]
>>>
```

Нарешті, прочитайте рядок даних і перетворіть його на словник за допомогою компрехенції словника:
```python
>>> row = next(rows)
>>> record = { colname: row[index] for colname, index in zip(select, indices) }   # компрехенція словника
>>> record
{'price': '32.20', 'name': 'AA', 'shares': '100'}
>>>
```

Якщо ви відчуваєте себе комфортно з тим, що щойно сталося, прочитайте решту файлу:
```python
>>> portfolio = [ { colname: row[index] for colname, index in zip(select, indices) } for row in rows ]
>>> portfolio
[{'price': '91.10', 'name': 'IBM', 'shares': '50'}, {'price': '83.44', 'name': 'CAT', 'shares': '150'},
  {'price': '51.23', 'name': 'MSFT', 'shares': '200'}, {'price': '40.37', 'name': 'GE', 'shares': '95'},
  {'price': '65.10', 'name': 'MSFT', 'shares': '50'}, {'price': '70.44', 'name': 'IBM', 'shares': '100'}]
>>>
```

Боже, ви щойно скоротили більшу частину функції `read_portfolio()` до одного рядка.

### Коментар

Компрехенція списків зазвичай використовується в Python як ефективний засіб для перетворення, фільтрації або збору даних. Через специфічний синтаксис, краще не перестаратися — намагайтеся, щоб компрехенція кожного списку була якомога простішою. Це нормально розбивати код на кілька етапів. Наприклад, зрозуміло, що ви не захочете виплеснути цей останній приклад на своїх нічого не підозрюючих колег.

Тим не менш, знання того, як швидко маніпулювати даними, є неймовірно корисним. Існує багато ситуацій, коли вам, можливо, доведеться вирішити якусь одноразову проблему, пов’язану з імпортом, експортом, вилученням даних тощо. Ставши гуру-майстром компрехенцій списків, можна значно скоротити час, витрачений на розробку рішення. Також не забудьте про модуль `collections`.

[Зміст](../Contents.md) \| [Попередній розділ (2.5. Модуль колекцій)](05_Collections.md) \| [Наступний розділ (2.7. Об'єкти)](07_Objects.md)
