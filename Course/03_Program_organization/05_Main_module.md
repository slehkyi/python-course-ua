[Зміст](../Contents.md) \| [Попередній розділ (3.4. Модулі)](04_Modules.md) \| [Наступний розділ (3.6. Обговорення дизайну)](06_Design_discussion.md)

# 3.5 Основний модуль

У цьому розділі представлено поняття основної програми або головного модуля.

### Основні функції

У багатьох мовах програмування існує поняття *основної* функції або методу.

```c
// c / c++
int main(int argc, char *argv[]) {
    ...
}
```

```java
// java
class myprog {
    public static void main(String args[]) {
        ...
    }
}
```

Це перша функція, яка виконується під час запуску програми.

### Головний модуль Python

У Python немає функції чи методу *main*. Натомість є *головний*
модуль. *Головний модуль* — це вихідний файл, який запускається першим.
```bash
bash % python3 prog.py
...
```

Будь-який файл, який ви надаєте інтерпретатору під час запуску, стає *основним*. Ім'я не має значення.

### `__main__` перевірка

Стандартною практикою для модулів, які виконуються як основний сценарій, є використання наступного формулювання:
```python
# prog.py
...
if __name__ == '__main__':
    # Виконується як основна програма ...
    statements
    ...
```

Оператори, укладені в оператор `if`, стають *основною* програмою.

### Основні програми vs. імпорт бібліотеки

Будь-який файл Python можна запускати як основний або як імпорт бібліотеки:

```bash
bash % python3 prog.py # Виконується як основна програма
```

```python
import prog   # Виконується як імпорт бібліотеки 
```

В обох випадках `__name__` є назвою модуля. Однак він буде встановлений як `__main__`, лише якщо працює як основний.

Зазвичай ви не хочете, щоб оператори, які є частиною основної програми, виконувалися під час імпорту бібліотеки. Отже, зазвичай є код перевірки `if-`, який можна використовувати в будь-якому випадку.

```python
if __name__ == '__main__':
    # Не виконується, якщо завантажено з імпортом ...
```

### Шаблон програми

Ось типовий шаблон для написання програми Python:

```python
# prog.py
# Імпорт операторів (бібліотек)
import modules

# Функції
def spam():
    ...

def blah():
    ...

# Основна функція
def main():
    ...

if __name__ == '__main__':
    main()
```

### Інструменти командного рядка

Python часто використовується для інструментів командного рядка

```bash
bash % python3 report.py portfolio.csv prices.csv
```

Це означає, що скрипти виконуються з оболонки/терміналу. Загальні випадки використання – це автоматизація, фонові завдання тощо.

### Аргументи командного рядка

Командний рядок — це список текстових рядків.

```bash
bash % python3 report.py portfolio.csv prices.csv
```

Цей список текстових рядків знаходиться в `sys.argv`.
```python
# У попередній команді bash
sys.argv # ['report.py, 'portfolio.csv', 'prices.csv']
```

Ось простий приклад обробки аргументів:
```python
import sys

if len(sys.argv) != 3:
    raise SystemExit(f'Usage: {sys.argv[0]} ' 'portfile pricefile')
portfile = sys.argv[1]
pricefile = sys.argv[2]
...
```

### Стандартний I/O

Стандартний ввід/вивід (або stdio) — це файли, які працюють так само, як і звичайні файли.

```python
sys.stdout
sys.stderr
sys.stdin
```

За замовчуванням друк спрямовується до `sys.stdout`. Вхідні дані зчитуються з `sys.stdin`. Логи та помилки спрямовуються до `sys.stderr`.

Майте на увазі, що *stdio* може бути підключений до терміналів, файлів, каналів тощо.

```bash
bash % python3 prog.py > results.txt
# or
bash % cmd1 | python3 prog.py | cmd2
```

### Змінні середовища

Змінні середовища встановлюються в оболонці.
```bash
bash % setenv NAME dave
bash % setenv RSH ssh
bash % python3 prog.py
```

`os.environ` є словником, який містить ці значення.

```python
import os

name = os.environ['NAME'] # 'dave'
```

Зміни відображаються в будь-яких підпроцесах, які пізніше запускає програма.

### Вихід з програми

Вихід з програми обробляється через винятки.

```python
raise SystemExit
raise SystemExit(exitcode)
raise SystemExit('Informative message')
```

Альтернатива.

```python
import sys
sys.exit(exitcode)
```

Ненульовий код виходу вказує на помилку.

### Рядок `#!`

В Unix рядок `#!` може запускати сценарій як Python.
Додайте наступне до першого рядка файлу сценарію.

```python
#!/usr/bin/env python3
# prog.py
...
```

Для цього потрібен дозвіл на виконання.
```bash
bash % chmod +x prog.py
# Тоді можна виконувати
bash % prog.py
... output ...
```

*Примітка: програма запуску Python у Windows також шукає рядок `#!`, щоб вказати версію мови.*

### Шаблон скрипта

Нарешті, ось загальний шаблон коду для програм Python, які виконуються як сценарії командного рядка:

```python
#!/usr/bin/env python3
# prog.py

# Імпорт операторів (бібліотек)
import modules

# Функції
def spam():
    ...

def blah():
    ...

# Основна функція
def main(argv):
    # Аналіз аргументів командного рядка, середовища тощо.
    ...

if __name__ == '__main__':
    import sys
    main(sys.argv)
```

## Вправи

### Вправа 3.15: функції `main()`

У файл `report.py` додайте функцію `main()`, яка приймає список параметрів командного рядка та створює той самий вихід, що й раніше. Ви повинні мати можливість запускати його в інтерактивному режимі так:

```python
>>> import report
>>> report.main(['report.py', 'Data/portfolio.csv', 'Data/prices.csv'])
      Name     Shares      Price     Change
---------- ---------- ---------- ----------
        AA        100       9.22     -22.98
       IBM         50     106.28      15.18
       CAT        150      35.46     -47.98
      MSFT        200      20.89     -30.34
        GE         95      13.48     -26.89
      MSFT         50      20.89     -44.21
       IBM        100     106.28      35.84
>>>
```

Змініть файл `pcost.py`, щоб він мав подібну функцію `main()`:

```python
>>> import pcost
>>> pcost.main(['pcost.py', 'Data/portfolio.csv'])
Total cost: 44671.15
>>>
```

### Вправа 3.16: Створення сценаріїв

Змініть програми `report.py` і `pcost.py`, щоб вони могли виконуватися як скрипти у командному рядку:

```bash
bash $ python3 report.py Data/portfolio.csv Data/prices.csv
      Name     Shares      Price     Change
---------- ---------- ---------- ----------
        AA        100       9.22     -22.98
       IBM         50     106.28      15.18
       CAT        150      35.46     -47.98
      MSFT        200      20.89     -30.34
        GE         95      13.48     -26.89
      MSFT         50      20.89     -44.21
       IBM        100     106.28      35.84

bash $ python3 pcost.py Data/portfolio.csv
Total cost: 44671.15
```

[Зміст](../Contents.md) \| [Попередній розділ (3.4. Модулі)](04_Modules.md) \| [Наступний розділ (3.6. Обговорення дизайну)](06_Design_discussion.md)
